## 1、数据库环境初始化

### 1）实体类

Entities文件夹下添加实体类：

父类

```C#
using Microsoft.EntityFrameworkCore;
using System.ComponentModel.DataAnnotations.Schema;
using System.ComponentModel.DataAnnotations;

namespace MyTodo.Api.Entities
{
    public class BaseEntity
    {
        //设置自增主键
        [Key]
        [DatabaseGenerated(DatabaseGeneratedOption.Identity)]
        [Comment("主键")]
        public int Id { get; set; }
        [Comment("创建时间")]
        public DateTime CreateTime { get; set; }
        [Comment("更新时间")]
        public DateTime UpdateTime { get; set; }

    }
}
```

备忘录Memo

```C#
using System.ComponentModel.DataAnnotations.Schema;
using System.ComponentModel.DataAnnotations;
using Microsoft.EntityFrameworkCore;

namespace MyTodo.Api.Entities
{
    [Table("T_Memo")]
    public class Memo : BaseEntity
    {
      
        [Comment("标题"),Required]
        public string Title { get; set; }
        [Comment("内容"), Required]
        public string Content { get; set; }

    }
}
```

待办Todo

```C#
using System.ComponentModel.DataAnnotations;
using System.ComponentModel.DataAnnotations.Schema;

namespace MyTodo.Api.Entities
{
    [Table("T_Todo")]
    public class Todo : BaseEntity
    {
        public string Title { get; set; }
        public string Content { get; set; }
        public string Status { get; set; }
    }
}
```

用户User

```C#
using Microsoft.EntityFrameworkCore;
using System.ComponentModel.DataAnnotations.Schema;
using System.ComponentModel.DataAnnotations;

namespace MyTodo.Api.Entities
{
    [Table("T_User")]
    public class User : BaseEntity
    {
        [Comment("标题"), Required]
        public string Account { get; set; }
        public string UserName { get; set; }

        [Comment("内容"), Required]
        public string Password { get; set; }

    }
}
```

### 2）配置数据库

项目中添加EFcore相关依赖包

```bash
NuGet\Install-Package Microsoft.EntityFrameworkCore -Version 6.0.0
NuGet\Install-Package Microsoft.EntityFrameworkCore.Relational -Version 6.0.0
NuGet\Install-Package Microsoft.EntityFrameworkCore.Design -Version 6.0.0
NuGet\Install-Package Microsoft.EntityFrameworkCore.Tools -Version 6.0.0

NuGet\Install-Package Microsoft.EntityFrameworkCore.SqlServer -Version 6.0.0
```

appsettings中增加数据库连接字符串

```json
{
  "ConnectionStrings": {
    "TodoConn": "Server=localhost;Database=test;User Id=sa;Password=root;"

  },
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    }
  },
  "AllowedHosts": "*"
}
```

新建一个DefaultDbContext作为数据库上下文

```C#
using System.Data.Common;
using Microsoft.EntityFrameworkCore;
using Microsoft.Extensions.Configuration;
using MyTodo.Api.Entities;

namespace MyTodo.Api.Contexts
{
    public class MyTodoContext : DbContext
    {
        public DbSet<User> Users { get; set; }
        public DbSet<Memo> Memos { get; set; }
        public DbSet<Todo> Todos { get; set; }

        protected override void OnConfiguring(DbContextOptionsBuilder optionsBuilder)
        {
            //var connectionString = _configuration.GetConnectionString("TodoConn");

            //optionsBuilder.UseSqlServer(connectionString);
            ////对数据库连接字符串
            //optionsBuilder.UseSqlServer("Server=localhost;Database=test;User Id=sa;Password=root;");
        }
        protected override void OnModelCreating(ModelBuilder modelBuilder)
        {
            base.OnModelCreating(modelBuilder);
        }

        public MyTodoContext(DbContextOptions<MyTodoContext> options) : base(options)
        {
            
        }
    }
}
```

当数据库连接字符串需要动态变化时在OnConfiguring中进行配置，初始化的数据库连接配置在program文件中依赖注入MyTodoContext时使用重写的构造函数`public MyTodoContext(DbContextOptions<MyTodoContext> options) : base(options)`

进行配置，所以program.cs中注入生命周期为Scoped的上下文实例

```C#
// 读取 appsettings.json 配置文件
builder.Configuration.AddJsonFile("appsettings.json", optional: false, reloadOnChange: true);

// 获取连接字符串
builder.Services.AddDbContext<MyTodoContext>(options =>
{
    var todoConnString = builder.Configuration.GetConnectionString("TodoConn");
    options.UseSqlServer(todoConnString);
    //options.UseSqlServer(builder.Configuration["ConnectionStrings:TodoConn"]);
},ServiceLifetime.Scoped);

```

运行数据迁移指令，在数据库生成对应的表

```bash
Add-Migration add_table_student
预览确认生成无误后 更新数据库表
update-database
```

## 2、添加UnitOfWork

如果想在多个仓储之间共享context，需要用到UnitOfWork，拷贝项目后将UnitOfWork文件夹拖入webapi项目中

```bash
git clone https://github.com/arch/UnitOfWork.git
```

安装UnitOfWork相关的依赖包

```bash
NuGet\Install-Package Microsoft.EntityFrameworkCore.AutoHistory -Version 6.0.0
```

建一个Repository文件夹，放入需要共享一个context的所有repository，并继承`UnitOfWork`的`Repository<T>`，实现`IRepository<T>`接口

MemoRepository

```C#
using Arch.EntityFrameworkCore.UnitOfWork;
using Microsoft.EntityFrameworkCore;
using MyTodo.Api.Contexts;
using MyTodo.Api.Entities;

namespace MyTodo.Api.Repository
{
    public class MemoRepository : Repository<Memo>, IRepository<Memo>
    {
        public MemoRepository(MyTodoContext dbContext) : base(dbContext)
        {
        }
    }
}
```

TodoRepository

```C#
using Arch.EntityFrameworkCore.UnitOfWork;
using Microsoft.EntityFrameworkCore;
using MyTodo.Api.Contexts;
using MyTodo.Api.Entities;

namespace MyTodo.Api.Repository
{
    /// <summary>
    /// 
    /// </summary>
    public class TodoRepository : Repository<Todo>, IRepository<Todo>
    {
        public TodoRepository(MyTodoContext dbContext) : base(dbContext)
        {
        }
    }
}
```

UserRepository

```C#
using Arch.EntityFrameworkCore.UnitOfWork;
using Microsoft.EntityFrameworkCore;
using MyTodo.Api.Contexts;
using MyTodo.Api.Entities;

namespace MyTodo.Api.Repository
{
    /// <summary>
    /// 
    /// </summary>
    public class UserRepository : Repository<User>, IRepository<User>
    {
        public UserRepository(MyTodoContext dbContext) : base(dbContext)
        {
        }
    }
}
```

program中注入repository

```C#
// 获取连接字符串
builder.Services.AddDbContext<MyTodoContext>(options =>
{
    var todoConnString = builder.Configuration.GetConnectionString("TodoConn");
    options.UseSqlServer(todoConnString);
    //options.UseSqlServer(builder.Configuration["ConnectionStrings:TodoConn"]);
},ServiceLifetime.Scoped)
    //注入AddUnitOfWork
    .AddUnitOfWork<MyTodoContext>()
    .AddCustomRepository<Todo,TodoRepository>()
    .AddCustomRepository<Memo, MemoRepository>()
    .AddCustomRepository<User, UserRepository>()
    ;

```

## 3、TodoController





